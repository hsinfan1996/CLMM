

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Fit halo mass to shear profile using Numcosmo statistical framework &mdash; CLMM 0.9.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API Documentation" href="../api.html" />
    <link rel="prev" title="Fit halo mass to shear profile: 3. accounting for the redshift distribution of source galaxies" href="Example3_Fit_Halo_Mass_to_Shear_Catalog.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> CLMM
          

          
          </a>

          
            
            
              <div class="version">
                0.9.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../source/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../source/citing.html">Citing CLMM</a></li>
</ul>
<p class="caption"><span class="caption-text">Usage Demos</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="demo_generate_mock_cluster.html">Generate Mock Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo_dataops_functionality.html">Measure a Profile</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo_theory_functionality.html">Model a Galaxy Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_and_model_demo_DC2.html">Basic usage of the cosmoDC2 extragalactic catalog with CLMM</a></li>
</ul>
<p class="caption"><span class="caption-text">Mass Fitting Examples</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Example1_Fit_Halo_Mass_to_Shear_Catalog.html">Fit halo mass to shear profile: 1. ideal data</a></li>
<li class="toctree-l1"><a class="reference internal" href="Example2_Fit_Halo_Mass_to_Shear_Catalog.html">Fit halo mass to shear profile: 2. realistic data and wrong model</a></li>
<li class="toctree-l1"><a class="reference internal" href="Example3_Fit_Halo_Mass_to_Shear_Catalog.html">Fit halo mass to shear profile: 3. accounting for the redshift distribution of source galaxies</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Fit halo mass to shear profile using Numcosmo statistical framework</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.constants.html">clmm.constants module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.cosmology.html">clmm.cosmology package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.cosmology.ccl.html">clmm.cosmology.ccl module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.cosmology.cluster_toolkit.html">clmm.cosmology.cluster_toolkit module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.cosmology.numcosmo.html">clmm.cosmology.numcosmo module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.cosmology.parent_class.html">clmm.cosmology.parent_class module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.dataops.html">clmm.dataops package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.galaxycluster.html">clmm.galaxycluster module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.gcdata.html">clmm.gcdata module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.theory.html">clmm.theory package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.theory.be_setup.html">clmm.theory.be_setup module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.theory.ccl.html">clmm.theory.ccl module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.theory.cluster_toolkit.html">clmm.theory.cluster_toolkit module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.theory.func_layer.html">clmm.theory.func_layer module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.theory.generic.html">clmm.theory.generic module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.theory.numcosmo.html">clmm.theory.numcosmo module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.theory.parent_class.html">clmm.theory.parent_class module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.plotting.html">clmm.plotting package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.utils.html">clmm.utils module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.support.html">clmm.support package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.support.mock_data.html">clmm.support.mock_data module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.support.sampler.html">clmm.support.sampler module</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CLMM</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Fit halo mass to shear profile using Numcosmo statistical framework</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/compiled-examples/Example2_Fit_Halo_Mass_to_Shear_Catalog_NC.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="fit-halo-mass-to-shear-profile-using-numcosmo-statistical-framework">
<h1>Fit halo mass to shear profile using Numcosmo statistical framework<a class="headerlink" href="#fit-halo-mass-to-shear-profile-using-numcosmo-statistical-framework" title="Permalink to this headline">¶</a></h1>
<p><em>the LSST-DESC CLMM team</em></p>
<p>This notebook demonstrates how to use <code class="docutils literal notranslate"><span class="pre">clmm</span></code> to estimate a WL halo
mass from observations of a galaxy cluster. It uses several
functionalities of the support <code class="docutils literal notranslate"><span class="pre">mock_data</span></code> module to produce datasets
of increasing complexity. It relies on Numcosmo tools for the
statistical analysis and shows how to fit for both cluster mass and
concentration.</p>
<ol class="arabic simple">
<li><p>The first part of notebook is equivalent to
<code class="docutils literal notranslate"><span class="pre">Example2_Fit_Halo_Mass_to_Shear_Catalog.ipynb</span></code> and demonstrates
the bias introduced on the reconstructed mass by a naive fit, when
the redshift distribution of the background galaxies is not properly
accounted for in the model.</p></li>
</ol>
<ul class="simple">
<li><p>Setting things up, with the proper imports.</p></li>
<li><p>Generating 3 datasets: an ideal dataset (dataset1) similar to that of
Example1 (single source plane); an ideal dataset but with source
galaxies following the Chang et al. (2013) redshift distribution
(dataset2); a noisy dataset where photoz errors and shape noise are
also included (dataset3).</p></li>
<li><p>Computing the binned reduced tangential shear profile, for the 3
datasets, using logarithmic binning.</p></li>
<li><p>Setting up the “single source plane” model to be fitted to the 3
datasets. Only dataset1 has a single source plane, so we expect to
see a bias in the reconstructed mass when using this model on
datasets 2 and 3.</p></li>
<li><p>Perform a simple fit using NumCosmo tools to compute the best-fit and
the Fisher Matrix, and visualize the results.</p></li>
<li><p>Perform a MCMC analysis using NumCosmo tools and visualize the
results.</p></li>
</ul>
<ol class="arabic simple" start="2">
<li><p>In a second part, an unbinned likelihood is build to properly account
for the redshift distribution, in a manner differing from that
presented in <code class="docutils literal notranslate"><span class="pre">Example3_Fit_Halo_Mass_to_Shear_Catalog.ipynb</span></code>. Both
the best-fit+Fisher matrix and MCMC analyses are used.</p></li>
</ol>
<p>NB: to display the corner plot output of the MCMC analysis, you will
need the <code class="docutils literal notranslate"><span class="pre">corner</span></code> package installed in your python environment.</p>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<p>First, we import some standard packages.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For NumCosmo</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">gi</span>

<span class="n">gi</span><span class="o">.</span><span class="n">require_version</span><span class="p">(</span><span class="s1">&#39;NumCosmo&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0&#39;</span><span class="p">)</span>
<span class="n">gi</span><span class="o">.</span><span class="n">require_version</span><span class="p">(</span><span class="s1">&#39;NumCosmoMath&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">gi.repository</span> <span class="kn">import</span> <span class="n">GObject</span>
<span class="kn">from</span> <span class="nn">gi.repository</span> <span class="kn">import</span> <span class="n">NumCosmo</span> <span class="k">as</span> <span class="n">Nc</span>
<span class="kn">from</span> <span class="nn">gi.repository</span> <span class="kn">import</span> <span class="n">NumCosmoMath</span> <span class="k">as</span> <span class="n">Ncm</span>

<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">chi2</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="c1"># The corner package is needed to view the results of the MCMC analysis</span>
<span class="kn">import</span> <span class="nn">corner</span>


<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CLMM_MODELING_BACKEND&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nc&#39;</span>

<span class="vm">__name__</span> <span class="o">=</span> <span class="s2">&quot;NcContext&quot;</span>

<span class="n">Ncm</span><span class="o">.</span><span class="n">cfg_init</span> <span class="p">()</span>
<span class="n">Ncm</span><span class="o">.</span><span class="n">cfg_set_log_handler</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">msg</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span> <span class="p">())</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span> <span class="kn">import</span> <span class="nn">clmm</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">notebook_install</span>
    <span class="n">notebook_install</span><span class="o">.</span><span class="n">install_clmm_pipeline</span><span class="p">(</span><span class="n">upgrade</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">clmm</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">random</span>
<span class="kn">from</span> <span class="nn">clmm.support.sampler</span> <span class="kn">import</span> <span class="n">fitters</span>

<span class="n">clmm</span><span class="o">.</span><span class="n">__version__</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;0.9.0&#39;</span>
</pre></div>
</div>
<p>Next, we import <code class="docutils literal notranslate"><span class="pre">clmm</span></code>’s core modules.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">clmm.dataops</span> <span class="k">as</span> <span class="nn">da</span>
<span class="kn">import</span> <span class="nn">clmm.galaxycluster</span> <span class="k">as</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">clmm.theory</span> <span class="k">as</span> <span class="nn">theory</span>
<span class="kn">from</span> <span class="nn">clmm</span> <span class="kn">import</span> <span class="n">Cosmology</span>
</pre></div>
</div>
<p>We then import a support modules for a specific data sets. <code class="docutils literal notranslate"><span class="pre">clmm</span></code>
includes support modules that enable the user to generate mock data in a
format compatible with <code class="docutils literal notranslate"><span class="pre">clmm</span></code>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">clmm.support</span> <span class="kn">import</span> <span class="n">mock_data</span> <span class="k">as</span> <span class="n">mock</span>
</pre></div>
</div>
</div>
<div class="section" id="making-mock-data">
<h2>Making mock data<a class="headerlink" href="#making-mock-data" title="Permalink to this headline">¶</a></h2>
<p>For reproducibility:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
</pre></div>
</div>
<p>To create mock data, we need to define a true cosmology.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mock_cosmo</span> <span class="o">=</span> <span class="n">Cosmology</span><span class="p">(</span><span class="n">H0</span> <span class="o">=</span> <span class="mf">70.0</span><span class="p">,</span> <span class="n">Omega_dm0</span> <span class="o">=</span> <span class="mf">0.27</span> <span class="o">-</span> <span class="mf">0.045</span><span class="p">,</span> <span class="n">Omega_b0</span> <span class="o">=</span> <span class="mf">0.045</span><span class="p">,</span> <span class="n">Omega_k0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span>
</pre></div>
</div>
<p>We now set some parameters for a mock galaxy cluster.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cosmo</span> <span class="o">=</span> <span class="n">mock_cosmo</span>
<span class="n">cluster_m</span> <span class="o">=</span> <span class="mf">1.e15</span> <span class="c1"># M200,m [Msun]</span>
<span class="n">cluster_z</span> <span class="o">=</span> <span class="mf">0.3</span>   <span class="c1"># Cluster&#39;s redshift</span>
<span class="n">concentration</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">ngals</span> <span class="o">=</span> <span class="mi">10000</span>     <span class="c1"># Number of galaxies</span>
<span class="n">Delta</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">cluster_ra</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">cluster_dec</span> <span class="o">=</span> <span class="mf">0.0</span>
</pre></div>
</div>
<p>Then we use the <code class="docutils literal notranslate"><span class="pre">mock_data</span></code> support module to generate 3 galaxy
catalogs: - <code class="docutils literal notranslate"><span class="pre">ideal_data</span></code>: all background galaxies at the same
redshift. - <code class="docutils literal notranslate"><span class="pre">ideal_data_z</span></code>: galaxies distributed according to the
Chang et al. (2013) redshift distribution. - <code class="docutils literal notranslate"><span class="pre">noisy_data_z</span></code>:
<code class="docutils literal notranslate"><span class="pre">ideal_data_z</span></code> + photoz errors + shape noise</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ideal_data</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">generate_galaxy_catalog</span><span class="p">(</span><span class="n">cluster_m</span><span class="p">,</span> <span class="n">cluster_z</span><span class="p">,</span> <span class="n">concentration</span><span class="p">,</span> <span class="n">cosmo</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">ngals</span><span class="o">=</span><span class="n">ngals</span><span class="p">)</span>
<span class="n">ideal_data_z</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">generate_galaxy_catalog</span><span class="p">(</span><span class="n">cluster_m</span><span class="p">,</span> <span class="n">cluster_z</span><span class="p">,</span> <span class="n">concentration</span><span class="p">,</span> <span class="n">cosmo</span><span class="p">,</span><span class="s1">&#39;chang13&#39;</span><span class="p">,</span> <span class="n">ngals</span><span class="o">=</span><span class="n">ngals</span><span class="p">)</span>
<span class="n">noisy_data_z</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">generate_galaxy_catalog</span><span class="p">(</span><span class="n">cluster_m</span><span class="p">,</span> <span class="n">cluster_z</span><span class="p">,</span> <span class="n">concentration</span><span class="p">,</span> <span class="n">cosmo</span><span class="p">,</span> <span class="s1">&#39;chang13&#39;</span><span class="p">,</span>
                                            <span class="n">shapenoise</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                                            <span class="n">photoz_sigma_unscaled</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">ngals</span><span class="o">=</span><span class="n">ngals</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">combet</span><span class="o">/</span><span class="n">anaconda3</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">clmmenv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">numpy</span><span class="o">/</span><span class="n">ma</span><span class="o">/</span><span class="n">core</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">2831</span><span class="p">:</span> <span class="n">VisibleDeprecationWarning</span><span class="p">:</span> <span class="n">Creating</span> <span class="n">an</span> <span class="n">ndarray</span> <span class="kn">from</span> <span class="nn">ragged</span> <span class="n">nested</span> <span class="n">sequences</span> <span class="p">(</span><span class="n">which</span> <span class="ow">is</span> <span class="n">a</span> <span class="nb">list</span><span class="o">-</span><span class="ow">or</span><span class="o">-</span><span class="nb">tuple</span> <span class="n">of</span> <span class="n">lists</span><span class="o">-</span><span class="ow">or</span><span class="o">-</span><span class="n">tuples</span><span class="o">-</span><span class="ow">or</span> <span class="n">ndarrays</span> <span class="k">with</span> <span class="n">different</span> <span class="n">lengths</span> <span class="ow">or</span> <span class="n">shapes</span><span class="p">)</span> <span class="ow">is</span> <span class="n">deprecated</span><span class="o">.</span> <span class="n">If</span> <span class="n">you</span> <span class="n">meant</span> <span class="n">to</span> <span class="n">do</span> <span class="n">this</span><span class="p">,</span> <span class="n">you</span> <span class="n">must</span> <span class="n">specify</span> <span class="s1">&#39;dtype=object&#39;</span> <span class="n">when</span> <span class="n">creating</span> <span class="n">the</span> <span class="n">ndarray</span>
  <span class="n">_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">,</span>
<span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">combet</span><span class="o">/.</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">clmm</span><span class="o">-</span><span class="mf">0.9</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">py3</span><span class="o">.</span><span class="mf">8.</span><span class="n">egg</span><span class="o">/</span><span class="n">clmm</span><span class="o">/</span><span class="n">theory</span><span class="o">/</span><span class="n">func_layer</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">354</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">Some</span> <span class="n">source</span> <span class="n">redshifts</span> <span class="n">are</span> <span class="n">lower</span> <span class="n">than</span> <span class="n">the</span> <span class="n">cluster</span> <span class="n">redshift</span><span class="o">.</span> <span class="n">kappa</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">those</span> <span class="n">galaxies</span><span class="o">.</span>
</pre></div>
</div>
<p>The galaxy catalogs are converted to a <code class="docutils literal notranslate"><span class="pre">clmm.GalaxyCluster</span></code> object and
may be saved for later use.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cluster_id</span> <span class="o">=</span> <span class="s2">&quot;CL_ideal&quot;</span>
<span class="n">gc_object</span> <span class="o">=</span> <span class="n">clmm</span><span class="o">.</span><span class="n">GalaxyCluster</span><span class="p">(</span><span class="n">cluster_id</span><span class="p">,</span> <span class="n">cluster_ra</span><span class="p">,</span> <span class="n">cluster_dec</span><span class="p">,</span>
                               <span class="n">cluster_z</span><span class="p">,</span> <span class="n">ideal_data</span><span class="p">)</span>
<span class="n">gc_object</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;ideal_GC.pkl&#39;</span><span class="p">)</span>

<span class="n">cluster_id</span> <span class="o">=</span> <span class="s2">&quot;CL_ideal_z&quot;</span>
<span class="n">gc_object</span> <span class="o">=</span> <span class="n">clmm</span><span class="o">.</span><span class="n">GalaxyCluster</span><span class="p">(</span><span class="n">cluster_id</span><span class="p">,</span> <span class="n">cluster_ra</span><span class="p">,</span> <span class="n">cluster_dec</span><span class="p">,</span>
                               <span class="n">cluster_z</span><span class="p">,</span> <span class="n">ideal_data_z</span><span class="p">)</span>
<span class="n">gc_object</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;ideal_GC_z.pkl&#39;</span><span class="p">)</span>

<span class="n">cluster_id</span> <span class="o">=</span> <span class="s2">&quot;CL_noisy_z&quot;</span>
<span class="n">gc_object</span> <span class="o">=</span> <span class="n">clmm</span><span class="o">.</span><span class="n">GalaxyCluster</span><span class="p">(</span><span class="n">cluster_id</span><span class="p">,</span> <span class="n">cluster_ra</span><span class="p">,</span> <span class="n">cluster_dec</span><span class="p">,</span>
                               <span class="n">cluster_z</span><span class="p">,</span> <span class="n">noisy_data_z</span><span class="p">)</span>
<span class="n">gc_object</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;noisy_GC_z.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Any saved <code class="docutils literal notranslate"><span class="pre">clmm.GalaxyCluster</span></code> object may be read in for analysis.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cl1</span> <span class="o">=</span> <span class="n">clmm</span><span class="o">.</span><span class="n">GalaxyCluster</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;ideal_GC.pkl&#39;</span><span class="p">)</span> <span class="c1"># all background galaxies at the same redshift</span>
<span class="n">cl2</span> <span class="o">=</span> <span class="n">clmm</span><span class="o">.</span><span class="n">GalaxyCluster</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;ideal_GC_z.pkl&#39;</span><span class="p">)</span> <span class="c1"># background galaxies distributed according to Chang et al. (2013)</span>
<span class="n">cl3</span> <span class="o">=</span> <span class="n">clmm</span><span class="o">.</span><span class="n">GalaxyCluster</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;noisy_GC_z.pkl&#39;</span><span class="p">)</span> <span class="c1"># same as cl2 but with photoz error and shape noise</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cluster info = ID:&quot;</span><span class="p">,</span> <span class="n">cl2</span><span class="o">.</span><span class="n">unique_id</span><span class="p">,</span> <span class="s2">&quot;; ra:&quot;</span><span class="p">,</span> <span class="n">cl2</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="s2">&quot;; dec:&quot;</span><span class="p">,</span> <span class="n">cl2</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="s2">&quot;; z_l :&quot;</span><span class="p">,</span> <span class="n">cl2</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The number of source galaxies is :&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cl2</span><span class="o">.</span><span class="n">galcat</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">Cluster</span> <span class="n">info</span> <span class="o">=</span> <span class="n">ID</span><span class="p">:</span> <span class="n">CL_ideal_z</span> <span class="p">;</span> <span class="n">ra</span><span class="p">:</span> <span class="mf">0.0</span> <span class="p">;</span> <span class="n">dec</span><span class="p">:</span> <span class="mf">0.0</span> <span class="p">;</span> <span class="n">z_l</span> <span class="p">:</span> <span class="mf">0.3</span>
<span class="n">The</span> <span class="n">number</span> <span class="n">of</span> <span class="n">source</span> <span class="n">galaxies</span> <span class="ow">is</span> <span class="p">:</span> <span class="mi">10000</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">h</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">cl2</span><span class="o">.</span><span class="n">galcat</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/Example2_Fit_Halo_Mass_to_Shear_Catalog_NC_22_0.png" src="../_images/Example2_Fit_Halo_Mass_to_Shear_Catalog_NC_22_0.png" />
</div>
<div class="section" id="deriving-observables">
<h2>Deriving observables<a class="headerlink" href="#deriving-observables" title="Permalink to this headline">¶</a></h2>
<div class="section" id="computing-shear">
<h3>Computing shear<a class="headerlink" href="#computing-shear" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">clmm.dataops.compute_tangential_and_cross_components</span></code> calculates the
tangential and cross shears for each source galaxy in the cluster.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">theta1</span><span class="p">,</span> <span class="n">g_t1</span><span class="p">,</span> <span class="n">g_x1</span> <span class="o">=</span> <span class="n">cl1</span><span class="o">.</span><span class="n">compute_tangential_and_cross_components</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="s2">&quot;flat&quot;</span><span class="p">)</span>
<span class="n">theta2</span><span class="p">,</span> <span class="n">g_t2</span><span class="p">,</span> <span class="n">g_x2</span> <span class="o">=</span> <span class="n">cl2</span><span class="o">.</span><span class="n">compute_tangential_and_cross_components</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="s2">&quot;flat&quot;</span><span class="p">)</span>
<span class="n">theta3</span><span class="p">,</span> <span class="n">g_t3</span><span class="p">,</span> <span class="n">g_x3</span> <span class="o">=</span> <span class="n">cl3</span><span class="o">.</span><span class="n">compute_tangential_and_cross_components</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="s2">&quot;flat&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="radially-binning-the-data">
<h3>Radially binning the data<a class="headerlink" href="#radially-binning-the-data" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bin_edges</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">make_bins</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;evenlog10width&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">clmm.dataops.make_radial_profile</span></code> evaluates the average shear of the
galaxy catalog in bins of radius.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">profile1</span> <span class="o">=</span> <span class="n">cl1</span><span class="o">.</span><span class="n">make_radial_profile</span><span class="p">(</span><span class="s2">&quot;Mpc&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span><span class="n">cosmo</span><span class="o">=</span><span class="n">cosmo</span><span class="p">)</span>
<span class="n">profile2</span> <span class="o">=</span> <span class="n">cl2</span><span class="o">.</span><span class="n">make_radial_profile</span><span class="p">(</span><span class="s2">&quot;Mpc&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span><span class="n">cosmo</span><span class="o">=</span><span class="n">cosmo</span><span class="p">)</span>
<span class="n">profile3</span> <span class="o">=</span> <span class="n">cl3</span><span class="o">.</span><span class="n">make_radial_profile</span><span class="p">(</span><span class="s2">&quot;Mpc&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span><span class="n">cosmo</span><span class="o">=</span><span class="n">cosmo</span><span class="p">)</span>
</pre></div>
</div>
<p>After running <code class="docutils literal notranslate"><span class="pre">clmm.dataops.make_radial_profile</span></code> on a
<code class="docutils literal notranslate"><span class="pre">clmm.GalaxyCluster</span></code> object, the object acquires the
<code class="docutils literal notranslate"><span class="pre">clmm.GalaxyCluster.profile</span></code> attribute.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cl1</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span> <span class="n">cl1</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%6.3e</span><span class="s2">&quot;</span>
<span class="n">cl1</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">max_width</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">radius_min</span>   <span class="n">radius</span>  <span class="n">radius_max</span>     <span class="n">gt</span>      <span class="n">gt_err</span>      <span class="n">gx</span>       <span class="n">gx_err</span>      <span class="n">z</span>       <span class="n">z_err</span>     <span class="n">n_src</span>
<span class="o">----------</span> <span class="o">---------</span> <span class="o">----------</span> <span class="o">---------</span> <span class="o">---------</span> <span class="o">----------</span> <span class="o">---------</span> <span class="o">---------</span> <span class="o">---------</span> <span class="o">---------</span>
 <span class="mf">7.000e-01</span> <span class="mf">7.446e-01</span>  <span class="mf">7.863e-01</span> <span class="mf">4.353e-02</span> <span class="mf">1.310e-04</span>  <span class="mf">1.817e-18</span> <span class="mf">1.119e-18</span> <span class="mf">8.000e-01</span> <span class="mf">2.916e-17</span> <span class="mf">5.800e+01</span>
 <span class="mf">7.863e-01</span> <span class="mf">8.403e-01</span>  <span class="mf">8.831e-01</span> <span class="mf">3.984e-02</span> <span class="mf">1.099e-04</span>  <span class="mf">1.652e-19</span> <span class="mf">7.336e-19</span> <span class="mf">8.000e-01</span> <span class="mf">2.394e-17</span> <span class="mf">8.600e+01</span>
 <span class="mf">8.831e-01</span> <span class="mf">9.395e-01</span>  <span class="mf">9.920e-01</span> <span class="mf">3.654e-02</span> <span class="mf">1.001e-04</span>  <span class="mf">2.066e-19</span> <span class="mf">9.422e-19</span> <span class="mf">8.000e-01</span> <span class="mf">3.417e-17</span> <span class="mf">9.500e+01</span>
 <span class="mf">9.920e-01</span> <span class="mf">1.052e+00</span>  <span class="mf">1.114e+00</span> <span class="mf">3.332e-02</span> <span class="mf">8.489e-05</span> <span class="o">-</span><span class="mf">3.696e-20</span> <span class="mf">4.365e-19</span> <span class="mf">8.000e-01</span> <span class="mf">1.933e-17</span> <span class="mf">1.320e+02</span>
 <span class="mf">1.114e+00</span> <span class="mf">1.187e+00</span>  <span class="mf">1.251e+00</span> <span class="mf">3.003e-02</span> <span class="mf">7.147e-05</span> <span class="o">-</span><span class="mf">3.648e-19</span> <span class="mf">4.370e-19</span> <span class="mf">8.000e-01</span> <span class="mf">1.807e-17</span> <span class="mf">1.510e+02</span>
 <span class="mf">1.251e+00</span> <span class="mf">1.331e+00</span>  <span class="mf">1.406e+00</span> <span class="mf">2.708e-02</span> <span class="mf">6.600e-05</span> <span class="o">-</span><span class="mf">3.547e-19</span> <span class="mf">2.933e-19</span> <span class="mf">8.000e-01</span> <span class="mf">1.718e-17</span> <span class="mf">1.670e+02</span>
 <span class="mf">1.406e+00</span> <span class="mf">1.495e+00</span>  <span class="mf">1.579e+00</span> <span class="mf">2.426e-02</span> <span class="mf">5.243e-05</span>  <span class="mf">3.573e-19</span> <span class="mf">2.912e-19</span> <span class="mf">8.000e-01</span> <span class="mf">0.000e+00</span> <span class="mf">2.350e+02</span>
 <span class="mf">1.579e+00</span> <span class="mf">1.677e+00</span>  <span class="mf">1.773e+00</span> <span class="mf">2.165e-02</span> <span class="mf">3.908e-05</span> <span class="o">-</span><span class="mf">8.774e-20</span> <span class="mf">2.324e-19</span> <span class="mf">8.000e-01</span> <span class="mf">5.995e-18</span> <span class="mf">3.430e+02</span>
 <span class="mf">1.773e+00</span> <span class="mf">1.887e+00</span>  <span class="mf">1.992e+00</span> <span class="mf">1.917e-02</span> <span class="mf">3.431e-05</span>  <span class="mf">4.064e-20</span> <span class="mf">1.454e-19</span> <span class="mf">8.000e-01</span> <span class="mf">0.000e+00</span> <span class="mf">4.010e+02</span>
 <span class="mf">1.992e+00</span> <span class="mf">2.119e+00</span>  <span class="mf">2.237e+00</span> <span class="mf">1.692e-02</span> <span class="mf">2.751e-05</span>  <span class="mf">2.809e-19</span> <span class="mf">1.411e-19</span> <span class="mf">8.000e-01</span> <span class="mf">0.000e+00</span> <span class="mf">4.990e+02</span>
 <span class="mf">2.237e+00</span> <span class="mf">2.377e+00</span>  <span class="mf">2.513e+00</span> <span class="mf">1.489e-02</span> <span class="mf">2.158e-05</span>  <span class="mf">4.850e-20</span> <span class="mf">8.535e-20</span> <span class="mf">8.000e-01</span> <span class="mf">8.623e-18</span> <span class="mf">6.630e+02</span>
 <span class="mf">2.513e+00</span> <span class="mf">2.672e+00</span>  <span class="mf">2.823e+00</span> <span class="mf">1.301e-02</span> <span class="mf">1.844e-05</span>  <span class="mf">1.162e-19</span> <span class="mf">8.492e-20</span> <span class="mf">8.000e-01</span> <span class="mf">0.000e+00</span> <span class="mf">7.800e+02</span>
 <span class="mf">2.823e+00</span> <span class="mf">2.999e+00</span>  <span class="mf">3.171e+00</span> <span class="mf">1.135e-02</span> <span class="mf">1.421e-05</span>  <span class="mf">9.388e-20</span> <span class="mf">6.017e-20</span> <span class="mf">8.000e-01</span> <span class="mf">0.000e+00</span> <span class="mf">1.042e+03</span>
 <span class="mf">3.171e+00</span> <span class="mf">3.369e+00</span>  <span class="mf">3.561e+00</span> <span class="mf">9.842e-03</span> <span class="mf">1.130e-05</span> <span class="o">-</span><span class="mf">3.198e-20</span> <span class="mf">4.625e-20</span> <span class="mf">8.000e-01</span> <span class="mf">3.078e-18</span> <span class="mf">1.301e+03</span>
 <span class="mf">3.561e+00</span> <span class="mf">3.781e+00</span>  <span class="mf">4.000e+00</span> <span class="mf">8.509e-03</span> <span class="mf">8.960e-06</span> <span class="o">-</span><span class="mf">2.406e-20</span> <span class="mf">3.252e-20</span> <span class="mf">8.000e-01</span> <span class="mf">2.738e-18</span> <span class="mf">1.644e+03</span>
</pre></div>
</div>
<p>We visualize the radially binned shear for the 3 configurations</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>


<span class="n">fsize</span> <span class="o">=</span> <span class="mi">14</span>
<span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">profile1</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span> <span class="n">profile1</span><span class="p">[</span><span class="s1">&#39;gt&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">profile1</span><span class="p">[</span><span class="s1">&#39;gt_err&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;z_src = 0.8&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">profile2</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span> <span class="n">profile2</span><span class="p">[</span><span class="s1">&#39;gt&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">profile2</span><span class="p">[</span><span class="s1">&#39;gt_err&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                   <span class="n">label</span><span class="o">=</span><span class="s1">&#39;z_src = Chang et al. (2013)&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">profile3</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span> <span class="n">profile3</span><span class="p">[</span><span class="s1">&#39;gt&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">profile3</span><span class="p">[</span><span class="s1">&#39;gt_err&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                   <span class="n">label</span><span class="o">=</span><span class="s1">&#39;z_src = Chang et al. (2013) + photoz err  + shape noise&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Binned shear of source galaxies&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fsize</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$r\;[Mpc]$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fsize</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$g_t$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fsize</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">Legend</span> <span class="n">at</span> <span class="mh">0x7fae6e768370</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="../_images/Example2_Fit_Halo_Mass_to_Shear_Catalog_NC_34_1.png" src="../_images/Example2_Fit_Halo_Mass_to_Shear_Catalog_NC_34_1.png" />
</div>
<div class="section" id="fitting-a-halo-mass-highlighting-bias-when-not-accounting-for-the-source-redshift-distribution-in-the-model">
<h3>Fitting a halo mass - highlighting bias when not accounting for the source redshift distribution in the model<a class="headerlink" href="#fitting-a-halo-mass-highlighting-bias-when-not-accounting-for-the-source-redshift-distribution-in-the-model" title="Permalink to this headline">¶</a></h3>
<p>We estimate the best-fit mass using a simple implementation of the
likelihood using a NcmDataGaussDiag object.</p>
<p>Here, to build the model we make the WRONG assumption that the average
shear in bin <span class="math notranslate nohighlight">\(i\)</span> equals the shear at the average redshift in the
bin; i.e. we assume that
<span class="math notranslate nohighlight">\(\langle g_t\rangle_i = g_t(\langle z\rangle_i)\)</span>. This should not
impact <code class="docutils literal notranslate"><span class="pre">cluster</span> <span class="pre">1</span></code> as all sources are located at the same redshift.
However, this yields a bias in the constructed mass for <code class="docutils literal notranslate"><span class="pre">cluster</span> <span class="pre">2</span></code>
and <code class="docutils literal notranslate"><span class="pre">cluster</span> <span class="pre">3</span></code>, where the sources followed the Chang et al. (2013)
distribution.</p>
<p>As expected, the reconstructed mass is biased whenever the sources are
not located at a single redshift as this was not accounted for in the
model.</p>
</div>
</div>
<div class="section" id="create-the-halo-model">
<h2>Create the halo model<a class="headerlink" href="#create-the-halo-model" title="Permalink to this headline">¶</a></h2>
<p>Here we model using the OO inteface, we also use NumCosmo statistical
framework to perform the analysis. Below we create an object based on
NumCosmo NcmDataGaussDiag (Gaussian likelihood with a diagonal
covariance matrix) object. To connect with the C interface the object
must implement the methods: <code class="docutils literal notranslate"><span class="pre">do_get_length</span></code>, <code class="docutils literal notranslate"><span class="pre">do_get_dof</span></code>,
<code class="docutils literal notranslate"><span class="pre">do_begin</span></code>, <code class="docutils literal notranslate"><span class="pre">do_prepare</span></code> and <code class="docutils literal notranslate"><span class="pre">do_mean_func</span></code>. The last method is
responsible to compute the theoretical predictions. In the
param_set_ftype calls below one can change between FREE/FIXED to
include/exclude the parameter from the analysis.</p>
<p>Remember that here we are building the wrong model.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GaussGammaTErr</span> <span class="p">(</span><span class="n">Ncm</span><span class="o">.</span><span class="n">DataGaussDiag</span><span class="p">):</span>
    <span class="n">z_cluster</span> <span class="o">=</span> <span class="n">GObject</span><span class="o">.</span><span class="n">Property</span> <span class="p">(</span><span class="nb">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">GObject</span><span class="o">.</span><span class="n">PARAM_READWRITE</span><span class="p">)</span>
    <span class="n">z_source</span>  <span class="o">=</span> <span class="n">GObject</span><span class="o">.</span><span class="n">Property</span> <span class="p">(</span><span class="nb">type</span> <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">Vector</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">GObject</span><span class="o">.</span><span class="n">PARAM_READWRITE</span><span class="p">)</span>
    <span class="n">r_source</span>  <span class="o">=</span> <span class="n">GObject</span><span class="o">.</span><span class="n">Property</span> <span class="p">(</span><span class="nb">type</span> <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">Vector</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">GObject</span><span class="o">.</span><span class="n">PARAM_READWRITE</span><span class="p">)</span>
    <span class="n">z_err</span>     <span class="o">=</span> <span class="n">GObject</span><span class="o">.</span><span class="n">Property</span> <span class="p">(</span><span class="nb">type</span> <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">Vector</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">GObject</span><span class="o">.</span><span class="n">PARAM_READWRITE</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Ncm</span><span class="o">.</span><span class="n">DataGaussDiag</span><span class="o">.</span><span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_points</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moo</span> <span class="o">=</span> <span class="n">clmm</span><span class="o">.</span><span class="n">Modeling</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">init_from_data</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z_cluster</span><span class="p">,</span> <span class="n">r_source</span><span class="p">,</span> <span class="n">z_source</span><span class="p">,</span> <span class="n">gt_profile</span><span class="p">,</span> <span class="n">gt_err</span><span class="p">,</span> <span class="n">z_err</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">moo</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">moo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moo</span> <span class="o">=</span> <span class="n">moo</span>

        <span class="k">assert</span> <span class="nb">len</span> <span class="p">(</span><span class="n">gt_profile</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span> <span class="p">(</span><span class="n">z_source</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span> <span class="p">(</span><span class="n">gt_profile</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span> <span class="p">(</span><span class="n">r_source</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span> <span class="p">(</span><span class="n">gt_profile</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span> <span class="p">(</span><span class="n">gt_err</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_size</span> <span class="p">(</span><span class="nb">len</span> <span class="p">(</span><span class="n">gt_profile</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">z_cluster</span> <span class="o">=</span> <span class="n">z_cluster</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">z_source</span>  <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">Vector</span><span class="o">.</span><span class="n">new_array</span> <span class="p">(</span><span class="n">z_source</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">r_source</span>  <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">Vector</span><span class="o">.</span><span class="n">new_array</span> <span class="p">(</span><span class="n">r_source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">z_err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">r_source</span>  <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">Vector</span><span class="o">.</span><span class="n">new_array</span> <span class="p">(</span><span class="n">z_err</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">set_array</span> <span class="p">(</span><span class="n">gt_profile</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">set_array</span> <span class="p">(</span><span class="n">gt_err</span><span class="p">)</span> <span class="c1"># Diagonal covariance matrix: standard deviation values in gt_err.</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">set_init</span> <span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Once the NcmDataGaussDiag is initialized, its parent class variable np is set with the n_points value.</span>
    <span class="k">def</span> <span class="nf">do_get_length</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span>

    <span class="k">def</span> <span class="nf">do_get_dof</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span>

    <span class="k">def</span> <span class="nf">do_begin</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">do_prepare</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moo</span><span class="o">.</span><span class="n">set_mset</span> <span class="p">(</span><span class="n">mset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_mean_func</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mset</span><span class="p">,</span> <span class="n">vp</span><span class="p">):</span>
        <span class="n">vp</span><span class="o">.</span><span class="n">set_array</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moo</span><span class="o">.</span><span class="n">eval_reduced_tangential_shear</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">r_source</span><span class="o">.</span><span class="n">dup_array</span> <span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">z_cluster</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">z_source</span><span class="o">.</span><span class="n">dup_array</span> <span class="p">()))</span>
        <span class="k">return</span>

<span class="n">GObject</span><span class="o">.</span><span class="n">type_register</span> <span class="p">(</span><span class="n">GaussGammaTErr</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">NcContext</span><span class="o">.</span><span class="n">GaussGammaTErr</span>
</pre></div>
</div>
<p>Defining the model set (NcmMset), data set (NcmDataset) and
NcmLikelihood objects to carry out a statistical analysis.</p>
<p>The method <code class="docutils literal notranslate"><span class="pre">param_set_ftype</span></code> defines the parameters that can be
fitted: <code class="docutils literal notranslate"><span class="pre">mid</span></code> - to which model set the parameter belongs to, <code class="docutils literal notranslate"><span class="pre">pid</span></code> -
parameters’ id, NcmParamType (FREE or FIXED) to say if the parameter
will be fitted or not.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">moo1</span> <span class="o">=</span> <span class="n">clmm</span><span class="o">.</span><span class="n">Modeling</span> <span class="p">(</span><span class="n">massdef</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">delta_mdef</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="n">halo_profile_model</span> <span class="o">=</span> <span class="s1">&#39;nfw&#39;</span><span class="p">)</span>
<span class="n">moo1</span><span class="o">.</span><span class="n">set_cosmo</span> <span class="p">(</span><span class="n">cosmo</span><span class="p">)</span>

<span class="n">moo2</span> <span class="o">=</span> <span class="n">clmm</span><span class="o">.</span><span class="n">Modeling</span> <span class="p">(</span><span class="n">massdef</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">delta_mdef</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="n">halo_profile_model</span> <span class="o">=</span> <span class="s1">&#39;nfw&#39;</span><span class="p">)</span>
<span class="n">moo2</span><span class="o">.</span><span class="n">set_cosmo</span> <span class="p">(</span><span class="n">cosmo</span><span class="p">)</span>

<span class="n">moo3</span> <span class="o">=</span> <span class="n">clmm</span><span class="o">.</span><span class="n">Modeling</span> <span class="p">(</span><span class="n">massdef</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">delta_mdef</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="n">halo_profile_model</span> <span class="o">=</span> <span class="s1">&#39;nfw&#39;</span><span class="p">)</span>
<span class="n">moo3</span><span class="o">.</span><span class="n">set_cosmo</span> <span class="p">(</span><span class="n">cosmo</span><span class="p">)</span>

<span class="n">ggt1</span> <span class="o">=</span> <span class="n">GaussGammaTErr</span> <span class="p">()</span>
<span class="n">ggt2</span> <span class="o">=</span> <span class="n">GaussGammaTErr</span> <span class="p">()</span>
<span class="n">ggt3</span> <span class="o">=</span> <span class="n">GaussGammaTErr</span> <span class="p">()</span>

<span class="n">ggt1</span><span class="o">.</span><span class="n">init_from_data</span> <span class="p">(</span><span class="n">z_cluster</span> <span class="o">=</span> <span class="n">cluster_z</span><span class="p">,</span> <span class="n">r_source</span> <span class="o">=</span> <span class="n">profile1</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span> <span class="n">z_source</span> <span class="o">=</span> <span class="n">profile1</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="n">gt_profile</span> <span class="o">=</span> <span class="n">profile1</span><span class="p">[</span><span class="s1">&#39;gt&#39;</span><span class="p">],</span> <span class="n">gt_err</span> <span class="o">=</span> <span class="n">profile1</span><span class="p">[</span><span class="s1">&#39;gt_err&#39;</span><span class="p">],</span> <span class="n">moo</span> <span class="o">=</span> <span class="n">moo1</span><span class="p">)</span>
<span class="n">ggt2</span><span class="o">.</span><span class="n">init_from_data</span> <span class="p">(</span><span class="n">z_cluster</span> <span class="o">=</span> <span class="n">cluster_z</span><span class="p">,</span> <span class="n">r_source</span> <span class="o">=</span> <span class="n">profile2</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span> <span class="n">z_source</span> <span class="o">=</span> <span class="n">profile2</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="n">gt_profile</span> <span class="o">=</span> <span class="n">profile2</span><span class="p">[</span><span class="s1">&#39;gt&#39;</span><span class="p">],</span> <span class="n">gt_err</span> <span class="o">=</span> <span class="n">profile2</span><span class="p">[</span><span class="s1">&#39;gt_err&#39;</span><span class="p">],</span> <span class="n">moo</span> <span class="o">=</span> <span class="n">moo2</span><span class="p">)</span>
<span class="n">ggt3</span><span class="o">.</span><span class="n">init_from_data</span> <span class="p">(</span><span class="n">z_cluster</span> <span class="o">=</span> <span class="n">cluster_z</span><span class="p">,</span> <span class="n">r_source</span> <span class="o">=</span> <span class="n">profile3</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span> <span class="n">z_source</span> <span class="o">=</span> <span class="n">profile3</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="n">gt_profile</span> <span class="o">=</span> <span class="n">profile3</span><span class="p">[</span><span class="s1">&#39;gt&#39;</span><span class="p">],</span> <span class="n">gt_err</span> <span class="o">=</span> <span class="n">profile3</span><span class="p">[</span><span class="s1">&#39;gt_err&#39;</span><span class="p">],</span> <span class="n">moo</span> <span class="o">=</span> <span class="n">moo3</span><span class="p">)</span>

<span class="n">mset1</span> <span class="o">=</span> <span class="n">ggt1</span><span class="o">.</span><span class="n">moo</span><span class="o">.</span><span class="n">get_mset</span> <span class="p">()</span>
<span class="n">mset2</span> <span class="o">=</span> <span class="n">ggt2</span><span class="o">.</span><span class="n">moo</span><span class="o">.</span><span class="n">get_mset</span> <span class="p">()</span>
<span class="n">mset3</span> <span class="o">=</span> <span class="n">ggt3</span><span class="o">.</span><span class="n">moo</span><span class="o">.</span><span class="n">get_mset</span> <span class="p">()</span>

<span class="c1">#Parameters: cluster mass (log base 10) and concentration</span>
<span class="n">MDelta_pi</span> <span class="o">=</span> <span class="n">mset1</span><span class="o">.</span><span class="n">param_get_by_full_name</span> <span class="p">(</span><span class="s2">&quot;NcHaloDensityProfile:log10MDelta&quot;</span><span class="p">)</span>
<span class="n">cDelta_pi</span> <span class="o">=</span> <span class="n">mset1</span><span class="o">.</span><span class="n">param_get_by_full_name</span> <span class="p">(</span><span class="s2">&quot;NcHaloDensityProfile:cDelta&quot;</span><span class="p">)</span>

<span class="n">mset1</span><span class="o">.</span><span class="n">param_set_ftype</span> <span class="p">(</span><span class="n">MDelta_pi</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span> <span class="n">MDelta_pi</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">ParamType</span><span class="o">.</span><span class="n">FREE</span><span class="p">)</span>
<span class="n">mset1</span><span class="o">.</span><span class="n">param_set_ftype</span> <span class="p">(</span><span class="n">cDelta_pi</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span> <span class="n">cDelta_pi</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">ParamType</span><span class="o">.</span><span class="n">FREE</span><span class="p">)</span>
<span class="n">mset1</span><span class="o">.</span><span class="n">prepare_fparam_map</span> <span class="p">()</span>

<span class="n">mset2</span><span class="o">.</span><span class="n">param_set_ftype</span> <span class="p">(</span><span class="n">MDelta_pi</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span> <span class="n">MDelta_pi</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">ParamType</span><span class="o">.</span><span class="n">FREE</span><span class="p">)</span>
<span class="n">mset2</span><span class="o">.</span><span class="n">param_set_ftype</span> <span class="p">(</span><span class="n">cDelta_pi</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span> <span class="n">cDelta_pi</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">ParamType</span><span class="o">.</span><span class="n">FREE</span><span class="p">)</span>
<span class="n">mset2</span><span class="o">.</span><span class="n">prepare_fparam_map</span> <span class="p">()</span>

<span class="n">mset3</span><span class="o">.</span><span class="n">param_set_ftype</span> <span class="p">(</span><span class="n">MDelta_pi</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span> <span class="n">MDelta_pi</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">ParamType</span><span class="o">.</span><span class="n">FREE</span><span class="p">)</span>
<span class="n">mset3</span><span class="o">.</span><span class="n">param_set_ftype</span> <span class="p">(</span><span class="n">cDelta_pi</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span> <span class="n">cDelta_pi</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">ParamType</span><span class="o">.</span><span class="n">FREE</span><span class="p">)</span>
<span class="n">mset3</span><span class="o">.</span><span class="n">prepare_fparam_map</span> <span class="p">()</span>

<span class="n">dset1</span> <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">new</span> <span class="p">()</span>
<span class="n">dset1</span><span class="o">.</span><span class="n">append_data</span> <span class="p">(</span><span class="n">ggt1</span><span class="p">)</span>
<span class="n">lh1</span> <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">Likelihood</span><span class="o">.</span><span class="n">new</span> <span class="p">(</span><span class="n">dset1</span><span class="p">)</span>

<span class="n">dset2</span> <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">new</span> <span class="p">()</span>
<span class="n">dset2</span><span class="o">.</span><span class="n">append_data</span> <span class="p">(</span><span class="n">ggt2</span><span class="p">)</span>
<span class="n">lh2</span> <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">Likelihood</span><span class="o">.</span><span class="n">new</span> <span class="p">(</span><span class="n">dset2</span><span class="p">)</span>

<span class="n">dset3</span> <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">new</span> <span class="p">()</span>
<span class="n">dset3</span><span class="o">.</span><span class="n">append_data</span> <span class="p">(</span><span class="n">ggt3</span><span class="p">)</span>
<span class="n">lh3</span> <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">Likelihood</span><span class="o">.</span><span class="n">new</span> <span class="p">(</span><span class="n">dset3</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="fitting-parameters-fisher-matrix">
<h3>Fitting parameters: Fisher Matrix<a class="headerlink" href="#fitting-parameters-fisher-matrix" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">The NcmFit object receives the NcmLikelihood and NcmMset objects. The
user also indicates the fitting algorithm and the numerical
differentiation method.</div>
<div class="line">Functions <code class="docutils literal notranslate"><span class="pre">run</span></code> and <code class="docutils literal notranslate"><span class="pre">fisher</span></code> computes the
<a class="reference external" href="https://en.wikipedia.org/wiki/Maximum_likelihood_estimation">best-fit</a>
and the <a class="reference external" href="https://en.wikipedia.org/wiki/Fisher_information#Multivariate_normal_distribution">fisher
matrix</a>,
respectively. <code class="docutils literal notranslate"><span class="pre">log_info</span></code> prints the complete information about the
data used, models and its parameters, and <code class="docutils literal notranslate"><span class="pre">log_covar</span></code> prints the
best-fit along with the error-bar and the covariance matrix.</div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fit1</span> <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">Fit</span><span class="o">.</span><span class="n">new</span> <span class="p">(</span><span class="n">Ncm</span><span class="o">.</span><span class="n">FitType</span><span class="o">.</span><span class="n">NLOPT</span><span class="p">,</span> <span class="s2">&quot;ln-neldermead&quot;</span><span class="p">,</span> <span class="n">lh1</span><span class="p">,</span> <span class="n">mset1</span><span class="p">,</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">FitGradType</span><span class="o">.</span><span class="n">NUMDIFF_FORWARD</span><span class="p">)</span>
<span class="n">fit2</span> <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">Fit</span><span class="o">.</span><span class="n">new</span> <span class="p">(</span><span class="n">Ncm</span><span class="o">.</span><span class="n">FitType</span><span class="o">.</span><span class="n">NLOPT</span><span class="p">,</span> <span class="s2">&quot;ln-neldermead&quot;</span><span class="p">,</span> <span class="n">lh2</span><span class="p">,</span> <span class="n">mset2</span><span class="p">,</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">FitGradType</span><span class="o">.</span><span class="n">NUMDIFF_FORWARD</span><span class="p">)</span>
<span class="n">fit3</span> <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">Fit</span><span class="o">.</span><span class="n">new</span> <span class="p">(</span><span class="n">Ncm</span><span class="o">.</span><span class="n">FitType</span><span class="o">.</span><span class="n">NLOPT</span><span class="p">,</span> <span class="s2">&quot;ln-neldermead&quot;</span><span class="p">,</span> <span class="n">lh3</span><span class="p">,</span> <span class="n">mset3</span><span class="p">,</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">FitGradType</span><span class="o">.</span><span class="n">NUMDIFF_FORWARD</span><span class="p">)</span>

<span class="n">fit1</span><span class="o">.</span><span class="n">run</span> <span class="p">(</span><span class="n">Ncm</span><span class="o">.</span><span class="n">FitRunMsgs</span><span class="o">.</span><span class="n">SIMPLE</span><span class="p">)</span>
<span class="n">fit1</span><span class="o">.</span><span class="n">fisher</span> <span class="p">()</span>
<span class="n">fit1</span><span class="o">.</span><span class="n">log_info</span> <span class="p">()</span>
<span class="n">fit1</span><span class="o">.</span><span class="n">log_covar</span> <span class="p">()</span>

<span class="n">fit2</span><span class="o">.</span><span class="n">run</span> <span class="p">(</span><span class="n">Ncm</span><span class="o">.</span><span class="n">FitRunMsgs</span><span class="o">.</span><span class="n">SIMPLE</span><span class="p">)</span>
<span class="n">fit2</span><span class="o">.</span><span class="n">fisher</span> <span class="p">()</span>
<span class="n">fit2</span><span class="o">.</span><span class="n">log_info</span> <span class="p">()</span>
<span class="n">fit2</span><span class="o">.</span><span class="n">log_covar</span> <span class="p">()</span>

<span class="n">fit3</span><span class="o">.</span><span class="n">run</span> <span class="p">(</span><span class="n">Ncm</span><span class="o">.</span><span class="n">FitRunMsgs</span><span class="o">.</span><span class="n">SIMPLE</span><span class="p">)</span>
<span class="n">fit3</span><span class="o">.</span><span class="n">fisher</span> <span class="p">()</span>
<span class="n">fit3</span><span class="o">.</span><span class="n">log_info</span> <span class="p">()</span>
<span class="n">fit3</span><span class="o">.</span><span class="n">log_covar</span> <span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="visualization-of-the-results">
<h2>Visualization of the results<a class="headerlink" href="#visualization-of-the-results" title="Permalink to this headline">¶</a></h2>
<p>For visualization purpose, we calculate the reduced tangential shear
predicted by the model when using the average redshift of the catalog.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">gt_model1</span> <span class="o">=</span> <span class="n">moo1</span><span class="o">.</span><span class="n">eval_reduced_tangential_shear</span> <span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">cluster_z</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cl1</span><span class="o">.</span><span class="n">galcat</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]))</span>
<span class="n">gt_model2</span> <span class="o">=</span> <span class="n">moo2</span><span class="o">.</span><span class="n">eval_reduced_tangential_shear</span> <span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">cluster_z</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cl2</span><span class="o">.</span><span class="n">galcat</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]))</span>
<span class="n">gt_model3</span> <span class="o">=</span> <span class="n">moo3</span><span class="o">.</span><span class="n">eval_reduced_tangential_shear</span> <span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">cluster_z</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cl3</span><span class="o">.</span><span class="n">galcat</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]))</span>

<span class="n">m_est1</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">mset1</span><span class="o">.</span><span class="n">param_get</span> <span class="p">(</span><span class="n">MDelta_pi</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span> <span class="n">MDelta_pi</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
<span class="n">m_est2</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">mset2</span><span class="o">.</span><span class="n">param_get</span> <span class="p">(</span><span class="n">MDelta_pi</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span> <span class="n">MDelta_pi</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
<span class="n">m_est3</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">mset3</span><span class="o">.</span><span class="n">param_get</span> <span class="p">(</span><span class="n">MDelta_pi</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span> <span class="n">MDelta_pi</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>

<span class="c1"># Standard deviation</span>
<span class="n">m_est_err1</span> <span class="o">=</span> <span class="n">fit1</span><span class="o">.</span><span class="n">covar_sd</span> <span class="p">(</span><span class="n">MDelta_pi</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span> <span class="n">MDelta_pi</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span> <span class="o">*</span> <span class="n">m_est1</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span> <span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
<span class="n">m_est_err2</span> <span class="o">=</span> <span class="n">fit2</span><span class="o">.</span><span class="n">covar_sd</span> <span class="p">(</span><span class="n">MDelta_pi</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span> <span class="n">MDelta_pi</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span> <span class="o">*</span> <span class="n">m_est2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span> <span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
<span class="n">m_est_err3</span> <span class="o">=</span> <span class="n">fit3</span><span class="o">.</span><span class="n">covar_sd</span> <span class="p">(</span><span class="n">MDelta_pi</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span> <span class="n">MDelta_pi</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span> <span class="o">*</span> <span class="n">m_est3</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span> <span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>

<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">% 22.15e</span><span class="s2"> +/- </span><span class="si">%.0e</span><span class="s2"> </span><span class="si">% 22.15e</span><span class="s2"> +/- </span><span class="si">%.0e</span><span class="s2"> </span><span class="si">% 22.15e</span><span class="s2"> +/- </span><span class="si">%.0e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m_est1</span><span class="p">,</span> <span class="n">m_est_err1</span><span class="p">,</span> <span class="n">m_est2</span><span class="p">,</span> <span class="n">m_est_err2</span><span class="p">,</span> <span class="n">m_est3</span><span class="p">,</span> <span class="n">m_est_err3</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="mf">1.001805095144565e+15</span> <span class="o">+/-</span> <span class="mf">7e+11</span>  <span class="mf">8.710139243072430e+14</span> <span class="o">+/-</span> <span class="mf">3e+12</span>  <span class="mf">8.316548297494131e+14</span> <span class="o">+/-</span> <span class="mf">5e+13</span>
</pre></div>
</div>
<p>We visualize that prediction of reduced tangential shears along with the
data</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">profile1</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span> <span class="n">profile1</span><span class="p">[</span><span class="s1">&#39;gt&#39;</span><span class="p">],</span><span class="n">profile1</span><span class="p">[</span><span class="s1">&#39;gt_err&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ideal_data, M_input = </span><span class="si">%.3e</span><span class="s1"> Msun&#39;</span> <span class="o">%</span> <span class="n">cluster_m</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">gt_model1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;best fit model 1, M_fit = </span><span class="si">%.2e</span><span class="s1"> +/- </span><span class="si">%.2e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m_est1</span><span class="p">,</span> <span class="n">m_est_err1</span><span class="p">))</span>


<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">profile2</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span> <span class="n">profile2</span><span class="p">[</span><span class="s1">&#39;gt&#39;</span><span class="p">],</span><span class="n">profile2</span><span class="p">[</span><span class="s1">&#39;gt_err&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span>
                  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ideal_data_z, M_input = </span><span class="si">%.3e</span><span class="s1"> Msun&#39;</span> <span class="o">%</span> <span class="n">cluster_m</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">gt_model2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span>
               <span class="n">label</span><span class="o">=</span><span class="s1">&#39;best fit model 2, M_fit = </span><span class="si">%.2e</span><span class="s1"> +/- </span><span class="si">%.2e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m_est2</span><span class="p">,</span> <span class="n">m_est_err2</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Ideal data w/wo src redshift distribution&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fsize</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fsize</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;R [Mpc]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fsize</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;reduced tangential shear&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fsize</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">profile3</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span> <span class="n">profile3</span><span class="p">[</span><span class="s1">&#39;gt&#39;</span><span class="p">],</span><span class="n">profile3</span><span class="p">[</span><span class="s1">&#39;gt_err&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;noisy_data_z, M_input = </span><span class="si">%.3e</span><span class="s1"> Msun&#39;</span> <span class="o">%</span> <span class="n">cluster_m</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">gt_model3</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;best fit model 3, M_fit = </span><span class="si">%.2e</span><span class="s1"> +/- </span><span class="si">%.2e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m_est3</span><span class="p">,</span> <span class="n">m_est_err3</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Noisy data with src redshift distribution&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fsize</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fsize</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;R [Mpc]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fsize</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;reduced tangential shear&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fsize</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/Example2_Fit_Halo_Mass_to_Shear_Catalog_NC_47_0.png" src="../_images/Example2_Fit_Halo_Mass_to_Shear_Catalog_NC_47_0.png" />
<div class="section" id="to-investigate-further-the-results-we-make-a-mcmc-analysis-below">
<h3>To investigate further the results we make a MCMC analysis below.<a class="headerlink" href="#to-investigate-further-the-results-we-make-a-mcmc-analysis-below" title="Permalink to this headline">¶</a></h3>
<p>We begin by specifying if the run is single- or multi-thread:
<code class="docutils literal notranslate"><span class="pre">func_eval_set_max_threads</span></code> sets the maximum number of threads, and
<code class="docutils literal notranslate"><span class="pre">func_eval_log_pool_stats</span></code> prints the information about the thread
pool.</p>
<p>Then, we initialize the transition kernel object (NcmMSetTransKern)
which defines the distribution of the initial points of the parameter
space to be used by the ensemble sampler. In this example we use the
Gaussian transition kernel (NcmMSetTransKernGauss), with priors provided
by the NcmMset (<code class="docutils literal notranslate"><span class="pre">set_prior_from_mset</span></code>). <code class="docutils literal notranslate"><span class="pre">set_cov_from_rescale</span></code> sets
the covariance matrix with zero correlation and the diagonal terms
defined by the scale of each parameter times the argument of
<code class="docutils literal notranslate"><span class="pre">set_cov_from_rescale</span></code>.</p>
<p>Here we use the Ensemble Sampler MCMC (ESMCMC) method. <code class="docutils literal notranslate"><span class="pre">nwalkers</span></code> and
<code class="docutils literal notranslate"><span class="pre">walker</span></code> define the number of walkers and the algorithm used to move
the points in the ensemble. Running: <code class="docutils literal notranslate"><span class="pre">start_run</span></code>, <code class="docutils literal notranslate"><span class="pre">run_lre</span></code> and
<code class="docutils literal notranslate"><span class="pre">end_run</span></code>. <code class="docutils literal notranslate"><span class="pre">run_lre</span></code> runs the ESMCMC until the relative error of the
mean of each parameter is smaller than <span class="math notranslate nohighlight">\(10^{-3}\)</span>. Its first
argument (integer) indicates how many ensembles are computed before
applying any convergence test.</p>
<p>In the end we save the catalog to mcat_wrong to compare with a correct
analysis.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Ncm</span><span class="o">.</span><span class="n">func_eval_set_max_threads</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">Ncm</span><span class="o">.</span><span class="n">func_eval_log_pool_stats</span> <span class="p">()</span>

<span class="n">init_sampler</span> <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">MSetTransKernGauss</span><span class="o">.</span><span class="n">new</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">init_sampler</span><span class="o">.</span><span class="n">set_mset</span> <span class="p">(</span><span class="n">mset3</span><span class="p">)</span>
<span class="n">init_sampler</span><span class="o">.</span><span class="n">set_prior_from_mset</span> <span class="p">()</span>
<span class="n">init_sampler</span><span class="o">.</span><span class="n">set_cov_from_rescale</span> <span class="p">(</span><span class="mf">1.0e-1</span><span class="p">)</span>

<span class="n">nwalkers</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># Number of walkers</span>
<span class="n">walker</span> <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">FitESMCMCWalkerAPS</span><span class="o">.</span><span class="n">new</span> <span class="p">(</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">mset3</span><span class="o">.</span><span class="n">fparams_len</span> <span class="p">())</span>

<span class="c1"># Ensemble Sampler MCMC</span>
<span class="n">esmcmc</span>  <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">FitESMCMC</span><span class="o">.</span><span class="n">new</span> <span class="p">(</span><span class="n">fit3</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">init_sampler</span><span class="p">,</span> <span class="n">walker</span><span class="p">,</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">FitRunMsgs</span><span class="o">.</span><span class="n">SIMPLE</span><span class="p">)</span>
<span class="n">esmcmc</span><span class="o">.</span><span class="n">set_data_file</span> <span class="p">(</span><span class="s2">&quot;example2_fit3_wrong_esmcmc_out_aps.fits&quot;</span><span class="p">)</span>
<span class="n">esmcmc</span><span class="o">.</span><span class="n">set_auto_trim</span> <span class="p">(</span><span class="kc">True</span><span class="p">)</span>            <span class="c1"># Detect and discard the burn-in points.</span>
<span class="n">esmcmc</span><span class="o">.</span><span class="n">set_auto_trim_div</span> <span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">esmcmc</span><span class="o">.</span><span class="n">set_max_runs_time</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="mf">60.0</span><span class="p">)</span>  <span class="c1"># Maximum time between tests.</span>

<span class="n">esmcmc</span><span class="o">.</span><span class="n">start_run</span> <span class="p">()</span>
<span class="n">esmcmc</span><span class="o">.</span><span class="n">run_lre</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mf">1.0e-3</span><span class="p">)</span>
<span class="n">esmcmc</span><span class="o">.</span><span class="n">end_run</span> <span class="p">()</span>

<span class="n">mcat_wrong</span> <span class="o">=</span> <span class="n">esmcmc</span><span class="o">.</span><span class="n">peek_catalog</span> <span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="correct-non-projected-model">
<h2>Correct non- projected model<a class="headerlink" href="#correct-non-projected-model" title="Permalink to this headline">¶</a></h2>
<p>Here, instead of building an object directly on top of NcmDataGauss*, we
use NumCosmo’s framework to build non-binned likelihood for weak-lensing
cluster analysis.</p>
<p>For that we need two objects: a NcGalaxyWLReducedShearGauss that model a
Gaussian distributed reduced shear likelihood, here the observables
matrix is simply <span class="math notranslate nohighlight">\((r, \gamma_t, \sigma_{\gamma_t})\)</span> for each
galaxy. If the data has spectroscopic redshifts then we use
NcGalaxyRedshiftSpec with an array of real redshifts. When photometric
errors are included we use the NcGalaxyRedshiftGauss object that
receives <span class="math notranslate nohighlight">\((z, \sigma_z)\)</span> for each galaxy.</p>
<p>Once we have the data objects ready we can proceed as in the previous
examples.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_nc_data_cluster_wl</span> <span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">g_t</span><span class="p">,</span> <span class="n">z_source</span><span class="p">,</span> <span class="n">z_cluster</span><span class="p">,</span> <span class="n">cosmo</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">sigma_z</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sigma_g</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">r</span>  <span class="o">=</span> <span class="n">clmm</span><span class="o">.</span><span class="n">convert_units</span> <span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="s2">&quot;radians&quot;</span><span class="p">,</span> <span class="s2">&quot;Mpc&quot;</span><span class="p">,</span> <span class="n">redshift</span> <span class="o">=</span> <span class="n">z_cluster</span><span class="p">,</span> <span class="n">cosmo</span> <span class="o">=</span> <span class="n">cosmo</span><span class="p">)</span>
    <span class="n">ga</span> <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">ObjArray</span><span class="o">.</span><span class="n">new</span> <span class="p">()</span>

    <span class="n">sigma_g</span> <span class="o">=</span> <span class="mf">1.0e-4</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">sigma_g</span> <span class="k">else</span> <span class="n">sigma_g</span>
    <span class="n">m_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span> <span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">g_t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span> <span class="p">(</span><span class="n">sigma_g</span><span class="p">,</span> <span class="nb">len</span> <span class="p">(</span><span class="n">r</span><span class="p">))))</span>

    <span class="n">grsg</span> <span class="o">=</span> <span class="n">Nc</span><span class="o">.</span><span class="n">GalaxyWLReducedShearGauss</span> <span class="p">(</span><span class="n">pos</span> <span class="o">=</span> <span class="n">Nc</span><span class="o">.</span><span class="n">GalaxyWLReducedShearGaussPos</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
    <span class="n">grsg</span><span class="o">.</span><span class="n">set_obs</span> <span class="p">(</span><span class="n">Ncm</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">new_array</span> <span class="p">(</span><span class="n">m_obs</span><span class="o">.</span><span class="n">flatten</span> <span class="p">(),</span> <span class="mi">3</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">sigma_z</span><span class="p">:</span>
        <span class="n">gzgs</span> <span class="o">=</span> <span class="n">Nc</span><span class="o">.</span><span class="n">GalaxyRedshiftGauss</span> <span class="p">()</span>
        <span class="n">z_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span> <span class="p">((</span><span class="n">z_source</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">z_source</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma_z</span><span class="p">))</span>
        <span class="n">gzgs</span><span class="o">.</span><span class="n">set_obs</span> <span class="p">(</span><span class="n">Ncm</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">new_array</span> <span class="p">(</span><span class="n">z_obs</span><span class="o">.</span><span class="n">flatten</span> <span class="p">(),</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gzgs</span> <span class="o">=</span> <span class="n">Nc</span><span class="o">.</span><span class="n">GalaxyRedshiftSpec</span> <span class="p">()</span>
        <span class="n">gzgs</span><span class="o">.</span><span class="n">set_z</span> <span class="p">(</span><span class="n">Ncm</span><span class="o">.</span><span class="n">Vector</span><span class="o">.</span><span class="n">new_array</span> <span class="p">(</span><span class="n">z_source</span><span class="p">))</span>

    <span class="n">gwl</span>  <span class="o">=</span> <span class="n">Nc</span><span class="o">.</span><span class="n">GalaxyWL</span> <span class="p">(</span><span class="n">wl_dist</span> <span class="o">=</span> <span class="n">grsg</span><span class="p">,</span> <span class="n">gz_dist</span> <span class="o">=</span> <span class="n">gzgs</span><span class="p">)</span>
    <span class="n">ga</span><span class="o">.</span><span class="n">add</span> <span class="p">(</span><span class="n">gwl</span><span class="p">)</span>

    <span class="n">nc_dcwl</span> <span class="o">=</span> <span class="n">Nc</span><span class="o">.</span><span class="n">DataClusterWL</span> <span class="p">(</span><span class="n">galaxy_array</span> <span class="o">=</span> <span class="n">ga</span><span class="p">,</span> <span class="n">z_cluster</span> <span class="o">=</span> <span class="n">z_cluster</span><span class="p">)</span>
    <span class="n">nc_dcwl</span><span class="o">.</span><span class="n">set_init</span> <span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nc_dcwl</span>

<span class="k">def</span> <span class="nf">create_fit_obj</span> <span class="p">(</span><span class="n">data_array</span><span class="p">,</span> <span class="n">mset</span><span class="p">):</span>
    <span class="n">dset</span> <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">new</span> <span class="p">()</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_array</span><span class="p">:</span>
        <span class="n">dset</span><span class="o">.</span><span class="n">append_data</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">lh</span> <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">Likelihood</span><span class="o">.</span><span class="n">new</span> <span class="p">(</span><span class="n">dset</span><span class="p">)</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">Fit</span><span class="o">.</span><span class="n">new</span> <span class="p">(</span><span class="n">Ncm</span><span class="o">.</span><span class="n">FitType</span><span class="o">.</span><span class="n">NLOPT</span><span class="p">,</span> <span class="s2">&quot;ln-neldermead&quot;</span><span class="p">,</span> <span class="n">lh</span><span class="p">,</span> <span class="n">mset</span><span class="p">,</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">FitGradType</span><span class="o">.</span><span class="n">NUMDIFF_FORWARD</span><span class="p">)</span>
    <span class="c1">#fit.set_params_reltol (1.0e-8)</span>
    <span class="c1">#fit.set_m2lnL_reltol (1.0e-11)</span>

    <span class="k">return</span> <span class="n">fit</span>

<span class="n">ggt1</span> <span class="o">=</span> <span class="n">create_nc_data_cluster_wl</span> <span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">g_t1</span><span class="p">,</span> <span class="n">cl1</span><span class="o">.</span><span class="n">galcat</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="n">cluster_z</span><span class="p">,</span> <span class="n">cosmo</span><span class="p">,</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">dist</span><span class="p">,</span> <span class="n">sigma_z</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sigma_g</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">ggt2</span> <span class="o">=</span> <span class="n">create_nc_data_cluster_wl</span> <span class="p">(</span><span class="n">theta2</span><span class="p">,</span> <span class="n">g_t2</span><span class="p">,</span> <span class="n">cl2</span><span class="o">.</span><span class="n">galcat</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="n">cluster_z</span><span class="p">,</span> <span class="n">cosmo</span><span class="p">,</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">dist</span><span class="p">,</span> <span class="n">sigma_z</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sigma_g</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">ggt3</span> <span class="o">=</span> <span class="n">create_nc_data_cluster_wl</span> <span class="p">(</span><span class="n">theta3</span><span class="p">,</span> <span class="n">g_t3</span><span class="p">,</span> <span class="n">cl3</span><span class="o">.</span><span class="n">galcat</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="n">cluster_z</span><span class="p">,</span> <span class="n">cosmo</span><span class="p">,</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">dist</span><span class="p">,</span> <span class="n">sigma_z</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">sigma_g</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">)</span>
</pre></div>
</div>
<p>As the likelihood is not Gaussian, here we compute the <a class="reference external" href="https://en.wikipedia.org/wiki/Observed_information">Observed Fisher
Matrix</a>
(<code class="docutils literal notranslate"><span class="pre">obs_fisher</span></code>).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fit1</span> <span class="o">=</span> <span class="n">create_fit_obj</span> <span class="p">([</span><span class="n">ggt1</span><span class="p">],</span> <span class="n">mset1</span><span class="p">)</span>
<span class="n">fit2</span> <span class="o">=</span> <span class="n">create_fit_obj</span> <span class="p">([</span><span class="n">ggt2</span><span class="p">],</span> <span class="n">mset2</span><span class="p">)</span>
<span class="n">fit3</span> <span class="o">=</span> <span class="n">create_fit_obj</span> <span class="p">([</span><span class="n">ggt3</span><span class="p">],</span> <span class="n">mset3</span><span class="p">)</span>

<span class="n">fit1</span><span class="o">.</span><span class="n">run</span> <span class="p">(</span><span class="n">Ncm</span><span class="o">.</span><span class="n">FitRunMsgs</span><span class="o">.</span><span class="n">SIMPLE</span><span class="p">)</span>
<span class="n">fit1</span><span class="o">.</span><span class="n">obs_fisher</span> <span class="p">()</span>
<span class="n">fit1</span><span class="o">.</span><span class="n">log_covar</span> <span class="p">()</span>

<span class="n">fit2</span><span class="o">.</span><span class="n">run</span> <span class="p">(</span><span class="n">Ncm</span><span class="o">.</span><span class="n">FitRunMsgs</span><span class="o">.</span><span class="n">SIMPLE</span><span class="p">)</span>
<span class="n">fit2</span><span class="o">.</span><span class="n">obs_fisher</span> <span class="p">()</span>
<span class="n">fit2</span><span class="o">.</span><span class="n">log_covar</span> <span class="p">()</span>

<span class="n">fit3</span><span class="o">.</span><span class="n">run</span> <span class="p">(</span><span class="n">Ncm</span><span class="o">.</span><span class="n">FitRunMsgs</span><span class="o">.</span><span class="n">SIMPLE</span><span class="p">)</span>
<span class="n">fit3</span><span class="o">.</span><span class="n">obs_fisher</span> <span class="p">()</span>
<span class="n">fit3</span><span class="o">.</span><span class="n">log_covar</span> <span class="p">()</span>

<span class="n">mest1</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">mset1</span><span class="o">.</span><span class="n">param_get</span> <span class="p">(</span><span class="n">MDelta_pi</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span> <span class="n">MDelta_pi</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
<span class="n">mest2</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">mset2</span><span class="o">.</span><span class="n">param_get</span> <span class="p">(</span><span class="n">MDelta_pi</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span> <span class="n">MDelta_pi</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
<span class="n">mest3</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">mset3</span><span class="o">.</span><span class="n">param_get</span> <span class="p">(</span><span class="n">MDelta_pi</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span> <span class="n">MDelta_pi</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">% 22.15e</span><span class="s2"> </span><span class="si">% 22.15e</span><span class="s2"> </span><span class="si">% 22.15e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mest1</span><span class="p">,</span> <span class="n">mest2</span><span class="p">,</span> <span class="n">mest3</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="mf">1.000016046300544e+15</span>  <span class="mf">9.999924790155086e+14</span>  <span class="mf">1.051887864605558e+15</span>
</pre></div>
</div>
</div>
<div class="section" id="visualizing-the-results">
<h2>Visualizing the results<a class="headerlink" href="#visualizing-the-results" title="Permalink to this headline">¶</a></h2>
<p>Note below that we no longer have biased results, all results are well
within the error bars. Note also that the error bars are substantially
smaller than in the binned case.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">gt_model1</span> <span class="o">=</span> <span class="n">moo1</span><span class="o">.</span><span class="n">eval_reduced_tangential_shear</span> <span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">cluster_z</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cl1</span><span class="o">.</span><span class="n">galcat</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]))</span>
<span class="n">gt_model2</span> <span class="o">=</span> <span class="n">moo2</span><span class="o">.</span><span class="n">eval_reduced_tangential_shear</span> <span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">cluster_z</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cl2</span><span class="o">.</span><span class="n">galcat</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]))</span>
<span class="n">gt_model3</span> <span class="o">=</span> <span class="n">moo3</span><span class="o">.</span><span class="n">eval_reduced_tangential_shear</span> <span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">cluster_z</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cl3</span><span class="o">.</span><span class="n">galcat</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]))</span>

<span class="n">m_est1</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">mset1</span><span class="o">.</span><span class="n">param_get</span> <span class="p">(</span><span class="n">MDelta_pi</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span> <span class="n">MDelta_pi</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
<span class="n">m_est2</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">mset2</span><span class="o">.</span><span class="n">param_get</span> <span class="p">(</span><span class="n">MDelta_pi</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span> <span class="n">MDelta_pi</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
<span class="n">m_est3</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">mset3</span><span class="o">.</span><span class="n">param_get</span> <span class="p">(</span><span class="n">MDelta_pi</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span> <span class="n">MDelta_pi</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>

<span class="n">m_est_err1</span> <span class="o">=</span> <span class="n">fit1</span><span class="o">.</span><span class="n">covar_sd</span> <span class="p">(</span><span class="n">MDelta_pi</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span> <span class="n">MDelta_pi</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span> <span class="o">*</span> <span class="n">m_est1</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span> <span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
<span class="n">m_est_err2</span> <span class="o">=</span> <span class="n">fit2</span><span class="o">.</span><span class="n">covar_sd</span> <span class="p">(</span><span class="n">MDelta_pi</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span> <span class="n">MDelta_pi</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span> <span class="o">*</span> <span class="n">m_est2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span> <span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
<span class="n">m_est_err3</span> <span class="o">=</span> <span class="n">fit3</span><span class="o">.</span><span class="n">covar_sd</span> <span class="p">(</span><span class="n">MDelta_pi</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span> <span class="n">MDelta_pi</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span> <span class="o">*</span> <span class="n">m_est3</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span> <span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>

<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">% 22.15e</span><span class="s2"> +/- </span><span class="si">%.0e</span><span class="s2"> </span><span class="si">% 22.15e</span><span class="s2"> +/- </span><span class="si">%.0e</span><span class="s2"> </span><span class="si">% 22.15e</span><span class="s2"> +/- </span><span class="si">%.0e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m_est1</span><span class="p">,</span> <span class="n">m_est_err1</span><span class="p">,</span> <span class="n">m_est2</span><span class="p">,</span> <span class="n">m_est_err2</span><span class="p">,</span> <span class="n">m_est3</span><span class="p">,</span> <span class="n">m_est_err3</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="mf">1.000016046300544e+15</span> <span class="o">+/-</span> <span class="mf">1e+11</span>  <span class="mf">9.999924790155086e+14</span> <span class="o">+/-</span> <span class="mf">1e+11</span>  <span class="mf">1.051887864605558e+15</span> <span class="o">+/-</span> <span class="mf">5e+13</span>
</pre></div>
</div>
<div class="section" id="id1">
<h3>To investigate further the results we make a MCMC analysis below.<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Ncm</span><span class="o">.</span><span class="n">func_eval_set_max_threads</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">Ncm</span><span class="o">.</span><span class="n">func_eval_log_pool_stats</span> <span class="p">()</span>

<span class="n">init_sampler</span> <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">MSetTransKernGauss</span><span class="o">.</span><span class="n">new</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">init_sampler</span><span class="o">.</span><span class="n">set_mset</span> <span class="p">(</span><span class="n">mset3</span><span class="p">)</span>
<span class="n">init_sampler</span><span class="o">.</span><span class="n">set_prior_from_mset</span> <span class="p">()</span>
<span class="n">init_sampler</span><span class="o">.</span><span class="n">set_cov_from_rescale</span> <span class="p">(</span><span class="mf">1.0e-1</span><span class="p">)</span>

<span class="n">nwalkers</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">stretch</span> <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">FitESMCMCWalkerAPS</span><span class="o">.</span><span class="n">new</span> <span class="p">(</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">mset3</span><span class="o">.</span><span class="n">fparams_len</span> <span class="p">())</span>

<span class="n">esmcmc</span>  <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">FitESMCMC</span><span class="o">.</span><span class="n">new</span> <span class="p">(</span><span class="n">fit3</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">init_sampler</span><span class="p">,</span> <span class="n">stretch</span><span class="p">,</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">FitRunMsgs</span><span class="o">.</span><span class="n">SIMPLE</span><span class="p">)</span>
<span class="n">esmcmc</span><span class="o">.</span><span class="n">set_data_file</span> <span class="p">(</span><span class="s2">&quot;example2_fit3_esmcmc_out_aps.fits&quot;</span><span class="p">)</span>
<span class="n">esmcmc</span><span class="o">.</span><span class="n">set_auto_trim</span> <span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">esmcmc</span><span class="o">.</span><span class="n">set_auto_trim_div</span> <span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">esmcmc</span><span class="o">.</span><span class="n">set_max_runs_time</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="mf">60.0</span><span class="p">)</span>

<span class="n">esmcmc</span><span class="o">.</span><span class="n">start_run</span> <span class="p">()</span>
<span class="n">esmcmc</span><span class="o">.</span><span class="n">run_lre</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mf">1.0e-3</span><span class="p">)</span>
<span class="n">esmcmc</span><span class="o">.</span><span class="n">end_run</span> <span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="below-we-plot-both-mcmc-results">
<h3>Below we plot both MCMC results<a class="headerlink" href="#below-we-plot-both-mcmc-results" title="Permalink to this headline">¶</a></h3>
<p>The wrong analysis has a strong bias in <span class="math notranslate nohighlight">\(\log_{10}(M_\Delta)\)</span> (the
peak of the wrong model is more than <span class="math notranslate nohighlight">\(3\sigma\)</span> away from the
correct model best-fit) and much larger variance.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s1d1</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">cdf</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">s1d2</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">cdf</span> <span class="p">(</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">s2d1</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">cdf</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">s2d2</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">cdf</span> <span class="p">(</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">s2d3</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">cdf</span> <span class="p">(</span><span class="mf">9.0</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">qts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">s1d2</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">s1d1</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">s1d1</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">s1d2</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">]</span>

<span class="n">mcat</span> <span class="o">=</span> <span class="n">esmcmc</span><span class="o">.</span><span class="n">peek_catalog</span> <span class="p">()</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span> <span class="p">([</span><span class="n">mcat</span><span class="o">.</span><span class="n">peek_row</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">dup_array</span> <span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">nwalkers</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="n">mcat</span><span class="o">.</span><span class="n">len</span> <span class="p">())])</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">mcat</span><span class="o">.</span><span class="n">col_symb</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;$&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">mcat</span><span class="o">.</span><span class="n">ncols</span> <span class="p">())]</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">corner</span><span class="o">.</span><span class="n">corner</span> <span class="p">(</span><span class="n">rows</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:],</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">reverse</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="c1">#quantiles=qts, levels = (s2d1, s2d2, s2d3),</span>
                        <span class="n">truths</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">15</span><span class="p">],</span> <span class="n">truth_color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span>
                        <span class="n">bins</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span> <span class="n">smooth</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">smooth1d</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>

<span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span> <span class="p">([</span><span class="n">mcat_wrong</span><span class="o">.</span><span class="n">peek_row</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">dup_array</span> <span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">nwalkers</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="n">mcat_wrong</span><span class="o">.</span><span class="n">len</span> <span class="p">())])</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">mcat_wrong</span><span class="o">.</span><span class="n">col_symb</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;$&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">mcat_wrong</span><span class="o">.</span><span class="n">ncols</span> <span class="p">())]</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">corner</span><span class="o">.</span><span class="n">corner</span> <span class="p">(</span><span class="n">rows</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:],</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="nb">range</span><span class="o">=</span><span class="p">[(</span><span class="mf">2.9</span><span class="p">,</span> <span class="mf">9.5</span><span class="p">),</span> <span class="p">(</span><span class="mf">14.8</span><span class="p">,</span> <span class="mf">15.12</span><span class="p">)],</span> <span class="n">reverse</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">levels</span> <span class="o">=</span> <span class="p">(</span><span class="n">s2d1</span><span class="p">,</span> <span class="n">s2d2</span><span class="p">,</span> <span class="n">s2d3</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
                        <span class="n">bins</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span> <span class="n">smooth</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">smooth1d</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="n">figure</span><span class="p">)</span>


<span class="n">figure</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/Example2_Fit_Halo_Mass_to_Shear_Catalog_NC_60_0.png" src="../_images/Example2_Fit_Halo_Mass_to_Shear_Catalog_NC_60_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ser</span> <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">Serialize</span><span class="o">.</span><span class="n">new</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">fit3</span><span class="o">.</span><span class="n">lh</span><span class="o">.</span><span class="n">dset</span><span class="o">.</span><span class="n">get_data</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ser</span><span class="o">.</span><span class="n">to_file</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;example2_fit3_data.obj&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2018-2021, LSST DESC CLMM Contributors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>